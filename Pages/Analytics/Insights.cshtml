@page
@model RetailMonolith.Pages.Analytics.InsightsModel
@{
    ViewData["Title"] = "Sales Insights";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <h1 class="mb-4">
                <i class="bi bi-graph-up"></i> Sales Insights
            </h1>
            <p class="text-muted">AI-powered analysis of your sales data using Azure OpenAI</p>
        </div>
    </div>

    @if (Model.IsLoading)
    {
        <div class="text-center my-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Analyzing sales data with Azure OpenAI...</p>
        </div>
    }
    else if (Model.ErrorMessage != null)
    {
        <div class="alert alert-danger" role="alert">
            <h4 class="alert-heading">Error</h4>
            <p>@Model.ErrorMessage</p>
            <hr>
            <p class="mb-0">Please check your Azure OpenAI configuration in appsettings.json</p>
        </div>
    }
    else if (Model.SalesData != null && Model.Insight != null)
    {
        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2">Total Orders</h6>
                        <h3 class="card-title">@Model.SalesData.TotalOrders</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2">Total Revenue</h6>
                        <h3 class="card-title">$@Model.SalesData.TotalRevenue.ToString("N2")</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2">Avg Order Value</h6>
                        <h3 class="card-title">$@Model.SalesData.AverageOrderValue.ToString("N2")</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-dark">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2">Analysis Period</h6>
                        <h3 class="card-title">@Model.DaysBack Days</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Insights -->
        <div class="row">
            <div class="col-md-12">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-lightbulb"></i> AI-Generated Summary</h5>
                        <small>Generated: @Model.Insight.GeneratedAt.ToString("MMM dd, yyyy HH:mm")</small>
                    </div>
                    <div class="card-body">
                        <p class="lead">@Model.Insight.Summary</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trends & Patterns with Interactive Charts -->
        <div class="row">
            <div class="col-md-12">
                <div class="card mb-4">
                    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-graph-up-arrow"></i> Trends & Patterns</h5>
                        <div class="btn-group" role="group" aria-label="Time period filter">
                            <button type="button" class="btn btn-sm btn-outline-light" data-days="7">7 Days</button>
                            <button type="button" class="btn btn-sm btn-outline-light active" data-days="30">30 Days</button>
                            <button type="button" class="btn btn-sm btn-outline-light" data-days="90">90 Days</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <h6 class="text-center">Revenue Over Time</h6>
                                <canvas id="revenueChart"></canvas>
                            </div>
                            <div class="col-md-6 mb-4">
                                <h6 class="text-center">Order Activity Over Time</h6>
                                <canvas id="ordersChart"></canvas>
                            </div>
                        </div>
                        <div class="alert alert-info mt-3" role="alert">
                            <strong>AI Insights:</strong> <span style="white-space: pre-wrap;">@Model.Insight.Trends</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recommendations -->
        <div class="row">
            <div class="col-md-12">
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-lightbulb-fill"></i> AI-Powered Recommendations for Sales Team</h5>
                        <small class="text-white-50">Actionable insights to boost revenue</small>
                    </div>
                    <div class="card-body">
                        @if (Model.Insight.ActionableRecommendations.Any())
                        {
                            <div class="row">
                                @foreach (var rec in Model.Insight.ActionableRecommendations)
                                {
                                    var badgeClass = rec.Priority switch
                                    {
                                        "High" => "danger",
                                        "Medium" => "warning",
                                        "Low" => "info",
                                        _ => "secondary"
                                    };
                                    var iconClass = rec.Category switch
                                    {
                                        "Upsell" => "bi-graph-up-arrow",
                                        "Pricing" => "bi-currency-dollar",
                                        "Marketing" => "bi-megaphone",
                                        "Inventory" => "bi-box-seam",
                                        "Customer" => "bi-people",
                                        _ => "bi-star"
                                    };
                                    
                                    <div class="col-md-6 mb-3">
                                        <div class="card h-100 border-start border-success border-4">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <h6 class="card-title mb-0">
                                                        <i class="bi @iconClass text-success"></i>
                                                        @rec.Title
                                                    </h6>
                                                    <span class="badge bg-@badgeClass">@rec.Priority Priority</span>
                                                </div>
                                                <p class="card-text text-muted small mb-2">@rec.Description</p>
                                                <div class="alert alert-success mb-0 py-2">
                                                    <strong><i class="bi bi-hand-thumbs-up"></i> Action:</strong> @rec.Action
                                                </div>
                                                @if (!string.IsNullOrEmpty(rec.Category))
                                                {
                                                    <small class="text-muted">
                                                        <span class="badge bg-light text-dark mt-2">@rec.Category</span>
                                                    </small>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <!-- Fallback to text-based recommendations -->
                            <div class="alert alert-info" role="alert">
                                <strong><i class="bi bi-info-circle"></i> Recommendations:</strong>
                                <div class="mt-2" style="white-space: pre-wrap;">@Model.Insight.Recommendations</div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Products -->
        @if (Model.SalesData.TopProducts.Any())
        {
            <div class="row">
                <div class="col-md-12">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-star-fill"></i> Top Selling Products</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Product</th>
                                            <th class="text-end">Units Sold</th>
                                            <th class="text-end">Revenue</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var product in Model.SalesData.TopProducts)
                                        {
                                            <tr>
                                                <td>@product.Name</td>
                                                <td class="text-end">@product.QuantitySold</td>
                                                <td class="text-end">$@product.Revenue.ToString("N2")</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Daily Sales Trend -->
        @if (Model.SalesData.DailySales.Any())
        {
            <div class="row">
                <div class="col-md-12">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-calendar3"></i> Recent Daily Sales</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th class="text-end">Orders</th>
                                            <th class="text-end">Revenue</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var day in Model.SalesData.DailySales.TakeLast(10).Reverse())
                                        {
                                            <tr>
                                                <td>@day.Date.ToString("MMM dd, yyyy")</td>
                                                <td class="text-end">@day.OrderCount</td>
                                                <td class="text-end">$@day.Revenue.ToString("N2")</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Refresh Button -->
        <div class="row">
            <div class="col-md-12 text-center">
                <form method="post">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="bi bi-arrow-clockwise"></i> Refresh Insights
                    </button>
                </form>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        let revenueChart = null;
        let ordersChart = null;
        let currentDays = @Model.DaysBack;
        let updateInterval = null;

        // Initialize charts when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadChartData(currentDays);
            setupTimeFilters();
            setupAutoRefresh();
        });

        function setupTimeFilters() {
            const buttons = document.querySelectorAll('[data-days]');
            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    // Remove active class from all buttons
                    buttons.forEach(btn => btn.classList.remove('active'));
                    // Add active class to clicked button
                    this.classList.add('active');
                    
                    currentDays = parseInt(this.getAttribute('data-days'));
                    loadChartData(currentDays);
                });
            });
        }

        function setupAutoRefresh() {
            // Refresh charts every 30 seconds
            updateInterval = setInterval(() => {
                loadChartData(currentDays);
            }, 30000);
        }

        async function loadChartData(days) {
            try {
                const response = await fetch(`/Analytics/Insights?handler=ChartData&days=${days}`);
                if (!response.ok) {
                    throw new Error('Failed to load chart data');
                }
                
                const data = await response.json();
                updateCharts(data);
            } catch (error) {
                console.error('Error loading chart data:', error);
            }
        }

        function updateCharts(data) {
            // Revenue Chart
            if (revenueChart) {
                revenueChart.data.labels = data.labels;
                revenueChart.data.datasets[0].data = data.revenue;
                revenueChart.update();
            } else {
                const revenueCtx = document.getElementById('revenueChart');
                revenueChart = new Chart(revenueCtx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Revenue ($)',
                            data: data.revenue,
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return 'Revenue: $' + context.parsed.y.toFixed(2);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toFixed(0);
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Orders Chart
            if (ordersChart) {
                ordersChart.data.labels = data.labels;
                ordersChart.data.datasets[0].data = data.orders;
                ordersChart.update();
            } else {
                const ordersCtx = document.getElementById('ordersChart');
                ordersChart = new Chart(ordersCtx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Order Count',
                            data: data.orders,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return 'Orders: ' + context.parsed.y;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
            }
        }

        // Clean up interval when leaving page
        window.addEventListener('beforeunload', function() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });
    </script>
}

